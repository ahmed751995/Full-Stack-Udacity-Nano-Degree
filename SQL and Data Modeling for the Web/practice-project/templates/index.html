<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Document</title>
    <style>
      .hidden {
	  display: none;
      }
      ul {
	  list-style: none;
	  margin: 0;
	  padding: 0;
	  width: 200px;
      }
      li {
	  clear: both;
      }
      
      li button {
	  border: none;
	  -webkit-appearance: none;
	  border: none;
	  color: red;
	  background: white;
	  float: right;
	  cursor: pointer;
	  font-size: 20px;
      }
    </style>
  </head>
  <body>
    <form id="form">
      <div>
	<input name="description" type="text"  id="description" />
        <input type="submit" value="add"/>
      </div>
    </form>
    <div id="error" class="hidden">Something goes wrong</div>
    <ul id="todos">
      {% for d in data %}
      <li>
	<input data-id="{{ d.id }}" class="check-completed" type="checkbox" {% if d.completed %} checked {% endif %} />
	{{ d.description }}
	<button class="delete-todo" data-id="{{ d.id }}">&cross;</button>
      </li>
      {% endfor %}
    </ul>

    <script>
      const deleteTodos = document.querySelectorAll(".delete-todo");
      for (let i = 0; i < deleteTodos.length; i++) {
	  const delete_todo = deleteTodos[i];
	  delete_todo.onclick = function(e) {
	      const todoId = e.target.dataset['id'];
	      fetch('/todos/' + todoId + '/delete', {
	   	  method: 'DELETE',
 		  headers: {
 		      'Content-Type': 'application/json'
	  	  }
	      })
 		  .then(function() {
		      const ul = e.target.parentNode.parentNode;
		      ul.removeChild(e.target.parentNode);
		      document.querySelector('#error').className = 'hidden';
 		  })
		  .catch(() => document.querySelector('#error').className = "")
	  }
      }
      
      const checkBoxes = document.querySelectorAll(".check-completed");
      for (let i = 0; i < checkBoxes.length; i++) {
	  const checkBox = checkBoxes[i];
	  checkBox.onchange = function(e) {
	      const completed = e.target.checked;
	      const todoId = e.target.dataset['id'];
	      fetch('/todos/'+ todoId +'/set-completed', {
		  method: 'POST',
		  body: JSON.stringify({
		      'completed': completed
		      
		  }),
		  headers: {
		      'Content-Type': 'application/json'
		  }
	      })
		  .then(function() {
		      document.querySelector('#error').className = 'hidden';
		  })
		  .catch(() => {
		      document.querySelector('#error').className = "";
		      e.target.checked = !e.target.checked;
		  })

	  }
      }	 
      document.querySelector("#form").addEventListener('submit', (e) => {
	  e.preventDefault();
	  fetch('/todos/create', {
	      method:'POST',
	      body: JSON.stringify({
		  'description': document.querySelector('#description').value
	      }),
	      headers: {
		  "Content-Type": "application/json"
	      }
	  })
	      .then(response => response.json())
	      .then(todo => {
		  const li = document.createElement("li");
		  li.innerHTML = `<input type="checkbox" data-id= "${todo['id']}"/> ${todo['description']} <button class="delete-todo" data-id="${todo['id']}">&cross;</button>`;
		  document.querySelector('#todos').appendChild(li);
		  document.querySelector('#error').className = 'hidden';
		  document.querySelector("#description").value = "";
	      })
	      .catch(() => {document.querySelector('#error').className = ""})
	  
      });
    </script>
  </body>
</html>
